<!DOCTYPE html>
<html>
<head>
	 <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.blue_grey-pink.min.css" />
	 <link rel="stylesheet" href="/css/styles.css">
	 <title>DigitalOcean &#43; Dokku &#43; Meteor</title>
	 <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	 
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Max Malm">
</head>
<body>

   <div class="demo-blog mdl-layout mdl-js-layout has-drawer is-upgraded">
      <main class="mdl-layout__content">
        <div class="demo-blog__posts mdl-grid">

			<div class="demo-back">
	          <a class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored" href="/" title="go back" role="button">
	            <i class="material-icons" role="presentation">arrow_back</i>
	          </a>
	        </div>
          <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
            <div class="mdl-card__media mdl-color-text--grey-50"
               
                style="background-image: url('/assets/ddm_splash.jpg')" 
              >
              <h3>DigitalOcean &#43; Dokku &#43; Meteor</h3>
            </div>
            <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
              <div class="section-spacer"></div>
              <div class="meta__favorites">
                425 <i class="material-icons" role="presentation">favorite</i>
                <span class="visuallyhidden">favorites</span>
              </div>
              <div>
                <i class="material-icons" role="presentation">bookmark</i>
                <span class="visuallyhidden">bookmark</span>
              </div>
              <div>
                <i class="material-icons" role="presentation">share</i>
                <span class="visuallyhidden">share</span>
              </div>
            </div>
            <div class="mdl-color-text--grey-700 mdl-card__supporting-text">
              

<p>So for two weeks now I&rsquo;ve been running Dokku on DigitalOcean for my Meteor apps (and some old PHP apps as well).</p>

<p>I&rsquo;ve read a few guides about it, but I feel they all leave something out so I&rsquo;ll try to collect everything I&rsquo;ve learned so far about the subject.</p>

<h3 id="what-is-dokku:2678be1fe8615c125bd40f0922167d34">What is Dokku?</h3>

<blockquote>
<p>Docker powered mini-Heroku. The smallest PaaS implementation you&rsquo;ve ever seen.</p>
</blockquote>

<p>Run docker containers without knowing Docker, push code via git and support for buildpacks. It&rsquo;s great!</p>

<h3 id="the-hard-choice:2678be1fe8615c125bd40f0922167d34">The hard choice</h3>

<p>First of all you want a domain to use for easier app control, let&rsquo;s use <code>apps.example.com</code> as our base and <code>*.apps.example.com</code> for our apps. Say we deploy an app called <code>test</code>, it would get the domain <code>test.apps.example.com</code>. We can of course add more domains later on, for example <code>test.com</code>. Choose a domain and we&rsquo;ll get back to this later.</p>

<h3 id="creating-the-server:2678be1fe8615c125bd40f0922167d34">Creating the server</h3>

<p>The DigitalOcean part is kind of straight forward. Sign up (<a href="https://www.digitalocean.com/?refcode=36ba60ad6e89">$10 free credit</a>) and go to <a href="https://cloud.digitalocean.com/droplets/new">Create droplet</a>. Pick a name for your droplet, for example <code>my-dokku</code>, choose a size and a region. Click on <strong>Applications</strong> and choose <strong>Dokku</strong>.</p>

<p>We do want add an SSH key for this droplet, if you&rsquo;re not familiar with SSH keys I suggest reading <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys--2">https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys&ndash;2</a>. Don&rsquo;t skip this step since you will have to read it later anyway and you will have trouble with pushing your application to Dokku.</p>

<p>Add your key and select it, then click on &ldquo;Create droplet&rdquo;</p>

<p><img src="/assets/ddm_create.png" alt="Image Alt" /></p>

<p>After the image is created you&rsquo;ll see the dashboard for your droplet. Here we can control our droplet such as power it off, remove it, take snapshots, and resize it. The important part here for now is the IP address. The one I got was <code>188.166.29.28</code></p>

<p><img src="/assets/ddm_droplet.png" alt="Image Alt" /></p>

<h3 id="configure-domain:2678be1fe8615c125bd40f0922167d34">Configure domain</h3>

<p>Now what I did was to point the domains we previously talked about to this IP address. In my case it looked like this:</p>

<pre><code>188.166.29.28 *.apps.example.com
188.166.29.28 apps.example.com
</code></pre>

<p>After this is done I point my browser to <a href="http://apps.example.com">http://apps.example.com</a> to continue with the Dokku setup. Since I&rsquo;ve already added my SSH public key it&rsquo;s already filled out by Dokku. Fill in <code>apps.example.com</code> under <strong>Hostname</strong> and click <em>Use virtualhost naming for apps</em>. Click <em>Finish setup</em> and we&rsquo;ll move on to the next step. You will here be redirected to the Dokku documentation for deploying the heroku node test app. Let&rsquo;s ignore this for now and move on to deploying our first Meteor application</p>

<p><img src="/assets/ddm_hostname.png" alt="Image Alt" /></p>

<h3 id="mongodb-dokku-true:2678be1fe8615c125bd40f0922167d34">MongoDB + dokku = true</h3>

<p>Before we actually deploy our app we need to add a MongoDB-container to our Dokku installation. SSH to <code>apps.example.com</code> using the SSH public key we created before. Run the following commands to install the MongoDB-plugin:</p>

<pre><code>git clone https://github.com/jeffutter/dokku-mongodb-plugin.git /var/lib/dokku/plugins/mongodb
dokku plugins-install
</code></pre>

<p>This might take a while since MongoDB has to be installed. If you want to read more about the plugin please see the Github repository at <a href="https://github.com/jeffutter/dokku-mongodb-plugin">https://github.com/jeffutter/dokku-mongodb-plugin</a></p>

<p>First we need to start the MongoDB-instance. Do this with <code>dokku mongodb:start</code>. Now let&rsquo;s create a db for our app, the one called <code>test</code> with <code>dokku mongodb:create test</code>.</p>

<h3 id="your-first-application:2678be1fe8615c125bd40f0922167d34">Your first application</h3>

<p>Put your SSH session aside and let&rsquo;s go back to our development. Let&rsquo;s use the Todos demo for Meteor</p>

<pre><code>meteor create --example todos test
cd test
meteor
</code></pre>

<p>This will start our Meteor application. We don&rsquo;t really need to but make sure everything works by going to <a href="http://localhost:3000">http://localhost:3000</a>.</p>

<p>Now we just need one more thing before we push our application to our Dokku installation, to tell Dokku how to build our application. Dokku doesn&rsquo;t really know it&rsquo;s a Meteor application but there is an easy way called buildpacks which instructs Dokku what it should do with the code we are sending.</p>

<p>Create a new file called <code>.env</code> in your root directory with the contents <code>export BUILDPACK_URL='https://github.com/AdmitHub/meteor-buildpack-horse.git'</code>. Dokku will then use this buildpack to compile and run our application.</p>

<h3 id="deploying:2678be1fe8615c125bd40f0922167d34">Deploying</h3>

<p>Now we just need to initialize a repository and push it to Dokku.</p>

<pre><code>git init
git add .
git commit -m &quot;initial commit&quot;
git remote add dokku dokku@apps.example.com:test
git push dokku master
</code></pre>

<p>Let&rsquo;s break it down. <code>git init</code> creates a local git repository. <code>git add .</code> stages all files in our directory and <code>git commit -m &quot;intial commit&quot;</code> creates a commit with the message <em>initial commit</em>. <code>git add</code> and <code>git commit</code> is probably the commands I use most when working with git.</p>

<p><code>git remote add dokku dokku@apps.example.com:test</code> tells us we have a remote destination called dokku and <code>dokku@apps.example.com:test</code> is the destination. <code>test</code> is what your app will be called later, in this case <code>test.apps.example.com</code>. <code>git push dokku master</code> pushes our HEAD to the remote location.</p>

<p>Your first deploy will fail since we have no <strong>ROOT_URL</strong> set which Meteor needs (<em>Error: Must pass options.rootUrl or set ROOT_URL in the server environment</em>). Go back to your SSH session and type <code>dokku config:set test ROOT_URL=http://test.apps.example.com</code>. This will the <strong>ROOT_URL</strong> and we can deploy again. We will not be needing to do this again. Also note in the build logs that <strong>MONGO_URL</strong> is set without us doing anything. If you want to run seperate MongoDB-servers you can set this value the same way as the <strong>ROOT_URL</strong>.</p>

<p>To deploy again just run <code>git push dokku master</code></p>

<p>So, now we can visit <a href="http://test.apps.example.com">http://test.apps.example.com</a> to see our app in all it&rsquo;s glory.</p>

<p>If you read the build logs you will notice the process stating it waits 35 seconds until finalizing your deploy. This is because we don&rsquo;t have any checks, but let&rsquo;s add that. In your project root create a file called <code>CHECKS</code>. In this put the following content:</p>

<pre><code>/ Todos - All your todos synced wherever you happen to be
</code></pre>

<p>This will check our website root for the text <em>Todos - All your todos synced wherever you happen to be</em>, if it&rsquo;s not there Dokku will abort the deploy.</p>

<h3 id="updating-your-application:2678be1fe8615c125bd40f0922167d34">Updating your application</h3>

<p>Now, add the file to git with <code>git add CHECKS</code> and commit it with <code>git commit -m &quot;added CHECKS file&quot;</code>. Now you can push it to Dokku again with <code>git push dokku master</code>. Now you&rsquo;ve also learned how to update your application!</p>

<p>Let&rsquo;s hook up our main domain, <code>test.com</code>. Point it to the same IP address as before.</p>

<p>Now in your SSH session type <code>dokku domains:add test test.com</code> where the first <em>test</em> is the name of our application. <em>www.test.com</em> will be added as well. Finally, change your <code>ROOT\_URL</code> to our new domain with <code>dokku config:set test ROOT_URL=http://test.com</code>. As you can see Dokku runs our CHECKS file here as well. Visit <a href="http://test.com">http://test.com</a> and enjoy the fruits of your hard work.</p>

<p><img src="/assets/ddm_deployed.gif" alt="Image Alt" /></p>

<p><em>In action</em></p>

<h3 id="what-now:2678be1fe8615c125bd40f0922167d34">What now?</h3>

<p>You most likely want to add a swap drive to your host to offload the RAM when the usage is high. See this excellent guide by Justin at <a href="https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-add-swap-on-ubuntu-14-04</a></p>

            </div>
          </div>
         </div>

        <footer class="mdl-mini-footer">
          <div class="mdl-mini-footer--left-section">
            
              <a href="https://github.com/benjick" class="mdl-button mdl-js-button mdl-mini-footer--social-btn social-btn social-btn__github">
                <span class="visuallyhidden">Github</span>
              </a>
            
            
            
              <a href="https://facebook.com/maxmalm" class="mdl-button mdl-js-button mdl-mini-footer--social-btn social-btn social-btn__facebook">
                <span class="visuallyhidden">Facebook</span>
              </a>
            

            
              <a href="https://twitter.com/benjick" class="mdl-button mdl-js-button mdl-mini-footer--social-btn social-btn social-btn__twitter">
                <span class="visuallyhidden">Twitter</span>
              </a>
            
            

            
              <a href="https://plus.google.com/u/1/+MaxMalm" class="mdl-button mdl-js-button mdl-mini-footer--social-btn social-btn social-btn__gplus">
                <span class="visuallyhidden">Google plus</span>
              </a>
            
          </div>
          
        </footer>
      </main>
      <div class="mdl-layout__obfuscator"></div>
    </div>
	<script src="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.min.js"></script>
<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
